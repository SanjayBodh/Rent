<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="icon" type="image/x-icon" href="images/logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Angkor&family=Caprasimo&family=Macondo&family=Moirai+One&family=RocknRoll+One&family=Titan+One&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="manifest" href="manifest.json">
<title>Update-user</title>
    <style>
a{
color:black;
text-decoration:none;
}
#email-icon{
font-size:25px;
position:relative;
top:6px;
color:white;
right:5px;
}
  button[type="button"]:disabled {
            background-color: #dddddd; /* Grey */
            color: #aaaaaa;
            cursor: not-allowed;
        }
input{
COLOR:black;
}
.body::-webkit-scrollbar {
  display: none;
    color:white;
    background:transparent;
}

 .body {
  -ms-overflow-style: none;  
  scrollbar-width: none;  
}

body::-webkit-scrollbar {
    display: none; 
background:transparent;
}

body::-webkit-scrollbar-track {
  background: transparent;
display:none; 
}

body::-webkit-scrollbar-thumb {
   background: transparent;
display:none; 
}
*{
-webkit-tap-highlight-color: rgba(0,0,0,0);
}

input,textarea,button,select,a{
-webkit-tap-highlight-color: rgba(0,0,0,0);
}
a:focus,a:visited,a:active{
outline:none;
}
.bod {
    user-select: none;
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* Internet Explorer/Edge */
}
html{
scroll-behavior:smooth;
}
body{
color:white;
    padding:0;
    margin:0;
    align-items:center;
    text-align:center;
    background:#008DDA;
font-family:rocknroll one;
 scrollbar-width: none; 
    -ms-overflow-style: none;
overflow:hidden;
}
.form-user{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
 width:40%;
height:70%;
border-radius:10px;
}
        .form-container {
            margin-bottom: 20px;
            padding: 20px;
            border: none;
          box-shadow:0px 5px 10px rgba(0,0,0,0.4);
            border-radius: 20px;
           

        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-group button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: not-allowed; /* Makes it visually clear that the button is disabled */
        }
input[type="email"],input[type="password"],input[type="text"],input[type="tel"]{
    width:92%;
    height:40px;
    border:none;
    border-radius:10px;
    background:white;
    font-size:15px;
    outline:none;
color:black;
padding:0px 20px;
}
button[type="button"]{
   font-size:15px;
    background:#333A73;
    border-radius:10px;
    border:2px solid white;
    color:white;
    padding:5px 35px;
    pointer:cursor;
transition:all 0.5s
}
button hover{
background:white;
border:2px solid blue;
color:blue;
transition:all 0.5s;
}
.left-arrow{
position:fixed;
top:2%;
left:2%;
background:white;
border-radius:10px;
padding:4px 15px;
font-size:12px;
box-shadow:0px 0px 4px 7px rgba(0,0,0,0.2);
}
.material-symbols-outlined{
position:relative;
font-size:13px;
top:2px;
}
@media(max-width:768px){
.form-user{
position:fixed;
top:60%;
left:50%;
transform:translate(-50%,-50%);
 width:100%;
height:100vh;
border-radius:10px;
}
input[type="email"],input[type="password"],input[type="text"],input[type="tel"]{
    width:80%;
    height:40px;
    border:none;
    border-radius:10px;
    background:white;
    font-size:15px;
    outline:none;
color:black;
padding:0px 20px;
}
button[type="button"]{
   font-size:15px;
    background:#333A73;
    border-radius:10px;
    border:2px solid white;
    color:white;
    padding:5px 25px;
    pointer:cursor;
transition:all 0.5s
}
}
    </style>
</head>
<body class="body">
<a href="index.html" class="left-arrow"><span class="material-symbols-outlined">
arrow_back_ios_new
</span> Home</a>
<div class="form-user">
<div class="form-container" id="passwordUpdateForm">
    <h2>Password Update</h2>
    <form id="passwordForm">
        <div class="form-group">
            <span id="email-icon" class="material-symbols-outlined">
mail
</span><input type="email" id="email" placeholder="name@example.com" disabled>
        </div>
        <div class="form-group">
            <span id="email-icon" class="material-symbols-outlined">
lock
</span><input type="password" id="oldPassword" placeholder="Old Password" disabled>
        </div>
        <div class="form-group">
            <span id="email-icon" class="material-symbols-outlined">
lock_open
</span><input type="password" id="newPassword" placeholder="New Password" disabled>
        </div>
        <div class="form-group">
            <span id="email-icon" class="material-symbols-outlined">
lock_open
</span><input type="password" id="confirmPassword" placeholder="Confirm Password" disabled>
        </div><br>
        <div class="form-group">
            <button type="button"  id="changePassword" disabled>Change Password</button>
        </div>
    </form>
</div>

<div class="form-container" id="userUpdateForm">
    <h2>User Update</h2>
    <form id="userInfoForm">
        <div class="form-group">
            <span id="email-icon" class="material-symbols-outlined">
person
</span><input type="text" id="firstname" placeholder="First Name" disabled>
        </div>
        <div class="form-group">
            <span id="email-icon" class="material-symbols-outlined">
person_add
</span><input type="text" id="lastname" placeholder="Last Name" disabled>
        </div><br>
        <div class="form-group">
             <button type="button" id="changeUserInfo" disabled>Update User Info</button> 
        </div>
    </form>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  import { getDatabase, get, ref, update, child } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, EmailAuthProvider, signOut, updatePassword, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

 const firebaseConfig = {
    apiKey: "AIzaSyBRZrQ35ZCsWtJ_Dvcq0w0iOED2ypXv89w",
    authDomain: "databse-b7f4b.firebaseapp.com",
    databaseURL: "https://databse-b7f4b-default-rtdb.firebaseio.com",
    projectId: "databse-b7f4b",
    storageBucket: "databse-b7f4b.appspot.com",
    messagingSenderId: "440573409846",
    appId: "1:440573409846:web:4a49d38fc1d5e5bb803697",
    measurementId: "G-JE7M0T3QSJ"
  };
   
   
  const app = initializeApp(firebaseConfig);
  const DB = getDatabase();
  const auth = getAuth(app);
  const dbref = ref(DB);

 let emailbox = document.getElementById('email');  
 let oldpassword= document.getElementById('oldPassword');
 let newpassword= document.getElementById('newPassword');
 let confirmpassword= document.getElementById('confirmPassword');
 let changepassword= document.getElementById('changePassword');

 let fname = document.getElementById('firstname'); 
 let lname= document.getElementById('lastname');
 let changeUserInfo= document.getElementById('changeUserInfo');
  
onAuthStateChanged(auth, (user)=> {
    if(user){
        get(child(dbref, 'UsersAuthList/' + user.uid))
        .then((snapshot)=>{
            fname.value = snapshot.val().firstname;
            lname.value = snapshot.val().lastname;
            fname.disabled = false;
            lname.disabled = false;
            changeUserInfo.disabled = false;
        })
        emailbox.value = user.email;
         oldpassword.disabled = false;
            newpassword.disabled = false;
            confirmpassword.disabled = false;
            changepassword.disabled = false;
    }
    else{
        window.location = 'index.html';
    }
})

let ChangePasswordFunc = () => {
    console.log("ChangePasswordFunc called");
    if (isNullOrWhiteSpaces(oldpassword.value) || isNullOrWhiteSpaces(newpassword.value) || isNullOrWhiteSpaces(confirmpassword.value)) {
        alert("Fill all fields");
        return;
    }
    if (newpassword.value !== confirmpassword.value) {
        alert("Passwords do not match");
        return;
    }
    const user = auth.currentUser;
    const credentials = EmailAuthProvider.credential(
        user.email,
        oldpassword.value
    );
    console.log("Reauthenticating user...");
    reauthenticateWithCredential(user, credentials)
        .then(() => {
            console.log("User reauthenticated successfully");
            updatePassword(user, newpassword.value)
                .then(() => {
                    console.log("Password updated successfully");
                    alert("Password was updated");
                    Signout();
                })
                .catch((error) => {
                    alert("Password was not updated\n\n" + error.message);
                });
        })
        .catch((error) => {
            alert("Password not updated. Check the old password you entered\n\n" + error.message);
        });
};

let ChangeUserInfoFunc = () => {
    if (isNullOrWhiteSpaces(fname.value) || isNullOrWhiteSpaces(lname.value)) {
        alert("Fill all fields");
        return;
    }

    const user = auth.currentUser;

    update(ref(db, 'UsersAuthList/' + user.uid), {
        firstname: fname.value,
        lastname: lname.value
    })
    .then(() => {
        alert("user info updated");
    })
    .catch((error) => {
        alert("user not updated successfully\n\n" + error);
    });
}




   let Signout = () => {
      signOut(auth).then(()=>{
        sessionStorage.removeItem("user-creds");
        sessionStorage.removeItem("user-info");
        window.location.href = 'index.html';
      }) 
    };
    let isNullOrWhiteSpaces = val => {
         val = val.toString();
         return (val == null) || (val.replaceAll(' ', '').length < 1);
       }

changepassword.addEventListener('click', ChangePasswordFunc);
changeUserInfo.addEventListener('click', ChangeUserInfoFunc);

</script>
</body>
</html>
</body>
</html>
